{% extends "base.html" %}
{% block title %}Agenda global{% endblock %}
{% block content %}
<h1 class="h4 mb-3">Agenda global</h1>

<div class="card shadow-sm mb-3">
  <div class="card-header"><strong>Filtros</strong></div>
  <div class="card-body">
    <form method="get" class="row g-2 align-items-end">
      <div class="col-md-3"><label class="form-label">Fecha</label>{{ form.fecha }}</div>
      <div class="col-md-5"><label class="form-label">Docente</label>{{ form.docente }}</div>
      <div class="col-md-2"><label class="form-label">Estado</label>{{ form.estado }}</div>
      <div class="col-md-2"><button class="btn btn-success w-100">Filtrar</button></div>
    </form>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span>Resultados</span>
    <a href="{% url 'exportar_citas_csv' %}?fecha={{ form.fecha.value }}&docente={{ form.docente.value }}&estado={{ form.estado.value }}" class="btn btn-sm btn-outline-secondary">Exportar CSV</a>
  </div>
  <div class="table-responsive">
    <table class="table mb-0">
      <thead class="table-light">
        <tr>
          <th>Fecha/Hora</th><th>Docente</th><th>Estudiante</th><th>Representante</th><th>Estado</th><th class="text-end">Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for c in citas %}
        <tr>
          <td>{{ c.inicio|date:"Y-m-d H:i" }}</td>
          <td>{{ c.docente.usuario.get_full_name|default:c.docente.usuario.username }}</td>
          <td>{{ c.nombre_estudiante }}</td>
          <td>{{ c.representante.email }}</td>
          <td><span class="badge {% if c.estado == 'CONFIRMADA' %}bg-success{% elif c.estado == 'PENDIENTE' %}bg-warning text-dark{% else %}bg-secondary{% endif %}">{{ c.estado }}</span></td>
          <td class="text-end">
            <a href="{% url 'cita_detalle_admin' c.pk %}" class="btn btn-sm btn-outline-secondary">Ver</a>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="6" class="text-center text-muted py-4">Sin resultados.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if citas.paginator.num_pages > 1 %}
  <div class="card-footer d-flex justify-content-center">
    <nav>
      <ul class="pagination pagination-sm mb-0">
        {% if citas.has_previous %}
          <li class="page-item"><a class="page-link" href="?page={{ citas.previous_page_number }}&fecha={{ form.fecha.value }}&docente={{ form.docente.value }}&estado={{ form.estado.value }}">«</a></li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">«</span></li>
        {% endif %}
        <li class="page-item disabled"><span class="page-link">Página {{ citas.number }} de {{ citas.paginator.num_pages }}</span></li>
        {% if citas.has_next %}
          <li class="page-item"><a class="page-link" href="?page={{ citas.next_page_number }}&fecha={{ form.fecha.value }}&docente={{ form.docente.value }}&estado={{ form.estado.value }}">»</a></li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">»</span></li>
        {% endif %}
      </ul>
    </nav>
  </div>
  {% endif %}
</div>
{% endblock %}
